# Работа с Systemd

Примеры работ с sytemd и юнит файлами.

## Создание своего сервиса и таймера

В директории *monitor* находятся необходимые файлы:

*monitor.service* сервис, который запускает необходимый нам скрипт, положить в */etc/systemd/system/*

*monitor.timer* таймер, который раз в 30 секунд запускает сервис, положить */etc/systemd/system/*

*monitor.config* конфигурационный файл, который содержит необходимые нам переменные для нанего сервиса, положить в */etc/sysconfig/*

*monitor.sh* наш скрипт для поиска ключевого слова

*access.log* лог файл для примера

Создание юнит файла для сервиса или скрипта с кодом завершения отличным от нуля, например exit 143. Для этого можно использовать параметр *SuccessExitStatus=143*, который добавляет код 143 как код успешного завершения, то есть дает понять systemd что процесс завершился корректно. Для рестарта подобных сервисов можно использовать параметр Restart со значением on-failure, который будет перезапускать сервис в случае получения кодов отличных от нуля (при добавлении кода в *SuccessExitStatus* как я понял в этом случае код не будет являться условием для рестарта), с помощью сигналов (кроме SIGUP, SIGINT, SIGTERM, SIGPIPE), по истечении времени ожидания операции и по настройке таймера. Пример юнит файла *monitor_143.service*.

## Создание сервиса из init скрипта

Устанавливаем spawn-fcgi и необходимые для него пакеты:

``
#yum install -y epel-release && yum install -y spawn-fcgi php php-cli mod_fcgid 
``

*httpd -yetc/rc.d/init.d/spawn-fcg* - необходимый нам init скрипт, по которому надо создать unit

*/etc/sysconfig/spawn-fcgi* - в этом файле конфигурации необходимо расскоментировать строки *SOCKET* и *OPTIONS*

Необходимый unit лежит в директории *spawn*.

## Создание нескольких экземпляров сервиса по шаблону

Дополним unit файл httpd изменив путь файла с переменными *EnvironmentFile=/etc/sysconfig/httpd_%i* добавив идентификатор *i%*, который позволяет передавать аргумент с помощью идентификатора *@*, который в свою очередь задается при запуске сервиса. 

Пример использования: Создадим для своего экземпляра сервиса свой файл с переменными */etc/sysconfig/httpd-8080*, где как раз указываем путь к файлу с конфигурацией *OPTIONS=-f conf/8080.conf*. Соответственно скопируем файл *httpd.conf* с конфигурацией и переименуем в *8080.conf*, в котором изменим  необходимые нам параметры .

``
PidFile /var/run/httpd/httpd-8080.pid
``

``
Listen 8080
``

Запускаем командой свой сервис *systemctl start httpd@8080*.

## Создание unit файла на примере Jira

Установим Jira по [инструкции](https://confluence.atlassian.com/adminjiraserver/installing-jira-applications-on-linux-938846841.html) с официального сайта.

В директории *jira* лежит созданный unit.
